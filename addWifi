#!/usr/bin/env bash

CONFIG_FILE=/etc/wpa_supplicant/wpa_supplicant.conf

usage_exit() {
    echo -e "Need the root permission\nUsage: $0 [-h] SSID [Passphrase]\nA Given SSID is registered on wpa_supplicant.conf.If Passphrase is not given, the network is registered as the open network.
    -h    this help message is appeared"
    exit 1
}

# check the help option or no arguments
if [ $# -eq 0 ]; then
    usage_exit
else
    while getopts h OPT
    do
        case $OPT in
            h) usage_exit
               ;;
            \?) usage_exit
                ;;
        esac
    done
    shift "$((OPTIND - 1))"
fi

# add SSID
if [ `whoami` != "root" ]; then
    echo "Must be root privilege to configure wifi settings"
    exit 1
else
    if [ $# -lt 1 -o 2 -lt $# ]; then
        echo "The number of args is not correct! Give one or two arguments!"
        exit 1
    else
        grep -o "ssid=\"$1\"" $CONFIG_FILE # confirm that given SSID is not registered
        if [ $? -eq 1 ]; then
            echo "" >> $CONFIG_FILE
            if [ $# -eq 1 ]; then   # only SSID argument
                echo "Wifi Open network"
                echo -e "network={\nssid=\"$1\"\nkey_mgmt=NONE\n}" >> $CONFIG_FILE && echo "SSID $1 was registered and you can connect."
            else                    # SSID and password
                echo "Protected Wifi network"
                TEMP=`wpa_passphrase $1 $2`
                if [ $? -eq 0 ]; then
                    echo -e "$TEMP" >> $CONFIG_FILE  && echo "SSID $1 was registered and you can connect."
                else
                    echo -e "$TEMP"
                fi
            fi
        else
            echo "Given SSID \"$1\" is already registered! This program won't update wpa_supplicant.conf."
        fi
    fi
fi
